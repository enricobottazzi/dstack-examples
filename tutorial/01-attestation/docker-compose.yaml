services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-slim
        WORKDIR /app
        RUN npm init -y && npm install @phala/dstack-sdk
        RUN cat > index.mjs <<'SCRIPT'
        import { DstackClient } from "@phala/dstack-sdk"
        import { createServer } from "http"
        import https from "https"
        import crypto from "crypto"

        const client = new DstackClient()
        const API_URL = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd"

        // Fetch URL and capture TLS certificate fingerprint
        function fetchWithTls(url) {
          return new Promise((resolve, reject) => {
            const urlObj = new URL(url)
            https.get({
              hostname: urlObj.hostname,
              path: urlObj.pathname + urlObj.search,
              headers: { 'User-Agent': 'dstack-oracle/1.0' }
            }, res => {
              const cert = res.socket.getPeerCertificate()
              let body = ""
              res.on("data", c => body += c)
              res.on("end", () => resolve({
                data: JSON.parse(body),
                tlsFingerprint: cert.fingerprint256,
                tlsIssuer: cert.issuer?.O,
                tlsValidTo: cert.valid_to
              }))
            }).on("error", reject)
          })
        }

        async function getAttestedPrice() {
          // 1. Fetch price with TLS certificate info
          const { data, tlsFingerprint, tlsIssuer, tlsValidTo } = await fetchWithTls(API_URL)

          // 2. Build statement (what we're attesting to)
          const statement = {
            source: "api.coingecko.com",
            price: data.bitcoin.usd,
            tlsFingerprint,
            tlsIssuer,
            tlsValidTo,
            timestamp: Date.now()
          }

          // 3. Hash statement and embed in TDX quote
          const hash = crypto.createHash("sha256").update(JSON.stringify(statement)).digest("hex")
          const quote = await client.getQuote(hash)

          return { statement, reportDataHash: hash, quote: quote.quote }
        }

        createServer(async (req, res) => {
          res.writeHead(200, { "Content-Type": "application/json" })
          if (req.url === "/price") {
            res.end(JSON.stringify(await getAttestedPrice(), null, 2))
          } else {
            const info = await client.info()
            res.end(JSON.stringify({ endpoints: ["/", "/price"], appId: info.app_id }, null, 2))
          }
        }).listen(8080, () => console.log("Oracle at http://localhost:8080"))
        SCRIPT
        CMD ["node", "index.mjs"]
    ports:
      - "8080:8080"
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
